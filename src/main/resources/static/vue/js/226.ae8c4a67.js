"use strict";(self["webpackChunkxy_dash_admin"]=self["webpackChunkxy_dash_admin"]||[]).push([[226],{226:function(a,e,t){t.r(e),t.d(e,{default:function(){return c}});t(7658);var o=t(3396),r=t(4870),i=t(7412),l=t(7178);const n=a=>((0,o.dD)("data-v-1028fd36"),a=a(),(0,o.Cn)(),a),m=n((()=>(0,o._)("span",{style:{color:"var(--el-text-color-regular)"}},"唯一名称",-1))),s=n((()=>(0,o._)("span",{style:{color:"var(--el-text-color-regular)"}},"选择主数据表",-1))),u=n((()=>(0,o._)("span",{style:{color:"var(--el-text-color-regular)"}},"权重",-1)));var d={__name:"table",props:{migrationsForm:{type:Object,default:null,required:!0}},setup(a,{expose:e}){const t=a,n=(0,r.iH)(null),d=(0,r.iH)([0]),g=(0,r.iH)(null),p=(0,r.qj)([]),c=(0,r.iH)(null),f=(0,r.iH)([0]);let F=(0,r.iH)({}),b=(0,o.Fl)((()=>JSON.stringify(p)));const S=(0,r.iH)({lazy:!0,lazyLoad(a,e){const{level:t}=a;setTimeout((()=>{let o=null;o=1==t?_(a.value.split(";")[0]):w(),o.then((a=>{null==a&&e([]);const o=a.map((a=>({value:1===t?a:a.id+";"+a.type,label:1===t?a:a.name,leaf:t>=1})));e(o)}))}),10)}}),h=function(a,e){if(null!=a){const o=n.value[e].getCheckedNodes()[0].parent.data,r=o.value.split(";"),i=t.migrationsForm.migrationDataSources.filter((e=>e.databaseName==a[1]&&e.sourceId==r[0]));if(i.length>0)t.migrationsForm.migrationDataSources[e]={},t.migrationsForm.data=t.migrationsForm.data.map((a=>{let e=!0;return t.migrationsForm.databaseName.forEach((t=>{t[1]==a[0].split(";")[0]&&(e=!1)})),1==e?null:a})),t.migrationsForm.dataSources=t.migrationsForm.dataSources.map((a=>{let e=!0;return t.migrationsForm.databaseName.forEach((t=>{t[1]==a[0].split(";")[0]&&(e=!1)})),1==e?null:a})),t.migrationsForm.databaseName[e]=null,l.z8.error("已存在相同配置");else{if(null!=t.migrationsForm.migrationDataSources[e]){const a=t.migrationsForm.migrationDataSources[e].uniqueName;t.migrationsForm.dataSources=t.migrationsForm.dataSources.filter((a=>"[]"!=JSON.stringify(a)&&null!=a)).filter((a=>a[0].split(";")[1]!=t.migrationsForm.migrationDataSources[e].sourceId||t.migrationsForm.migrationDataSources[e].databaseName!=a[0].split(";")[0])),t.migrationsForm.data=t.migrationsForm.data.filter((a=>"[]"!=JSON.stringify(a)&&null!=a)).filter((a=>a[0].split(";")[1]!=t.migrationsForm.migrationDataSources[e].sourceId||t.migrationsForm.migrationDataSources[e].databaseName!=a[0].split(";")[0])),t.migrationsForm.migrationDataSources[e]={},t.migrationsForm.migrationDataSources[e].uniqueName=a}t.migrationsForm.migrationDataSources[e].databaseName=a[1],t.migrationsForm.migrationDataSources[e].idx=t.migrationsForm.databaseName[e][0],t.migrationsForm.migrationDataSources[e].sourceId=r[0],t.migrationsForm.migrationDataSources[e].type=Number(r[1])}t.migrationsForm.migrationDataSources[e],setTimeout((function(){C()}),10)}else t.migrationsForm.migrationDataSources[e]={}},N=function(a,e,o){let r=null,i=null,l=null,n=null,m=null;if(1==o){if(m=t.migrationsForm.data[e][0],r=g,null!=c.value[e].getCheckedNodes()[0]){const a=c.value[e].getCheckedNodes()[0].parent.data,t=a.value.split(";");l=t[2],i=c.value[e].getCheckedNodes()[0].label}}else m=t.migrationsForm.dataSources[e][0],r=c,null!=g.value[e].getCheckedNodes()[0]&&(n=g.value[e].getCheckedNodes()[0].label);if(null!=a){t.migrationsForm.migrationDataSources=t.migrationsForm.migrationDataSources.map((a=>(null!=a.migrationTables&&(a.migrationTables=a.migrationTables.filter((a=>a.migration!=(1==o)||a.random!=f.value[e]))),a)));const s=r.value[e].getCheckedNodes()[0].parent.data,u=s.value.split(";"),d=(u[0],u[1],u[2]),g=u[3],c=u[4],F=p[e];let b={migration:1==o,position:F,name:a[1],idx:m,random:f.value[e],uniqueName:d,sourceName:i,sourceUniqueName:l,type:g};if(null==t.migrationsForm.migrationDataSources[c].migrationTables&&(t.migrationsForm.migrationDataSources[c].migrationTables=[]),t.migrationsForm.migrationDataSources[c].migrationTables.push(b),null!=n){t.migrationsForm.migrationDataSources[c].migrationTables.filter((a=>a.name==n)).map((e=>{e.sourceName=a[1],e.sourceUniqueName=d}))}}},v=function(){t.migrationsForm.migrationDataSources.push({}),t.migrationsForm.databaseName.push([]),d.value.push(1)},y=function(a){t.migrationsForm.dataSources.push([]),t.migrationsForm.data.push([]),f.value.push("number"!=typeof a?""+parseInt(1e6*Math.random()):a)},w=async()=>{const a=await i.ZP.get("admin_api/v1/dataSources/list");return a.data.data},_=async a=>{const e=await i.ZP.get("admin_api/v1/dataBase/"+a);return e.data.data},D=async(a,e)=>{const t=await i.ZP.get("admin_api/v1/dataBase//queryTable/"+a+"?dataName="+e);return t.data.data},k=a=>{let e=!0,t=!0;var o=new Map,r=new Map,i=new Set;C(),a.migrationDataSources.forEach(((l,n)=>{a.databaseName.push([l.sourceId+";"+l.type,l.databaseName]),1!=e?v():e=!1,null!=l.migrationTables&&l.migrationTables.filter((a=>null!=a.random)).forEach((a=>{let e=null;1==a.migration?(e=[l.databaseName+";"+l.sourceId+";"+l.uniqueName+";"+l.type+";"+n,a.name],o.set(a.random,e),p.push(a.position),1!=t?y(a.random):t=!1):(e=[l.databaseName+";"+l.sourceId+";"+l.uniqueName+";"+l.type+";"+n,a.name],r.set(a.random,e)),i.add(a.random)}))}));for(let l of f.value)a.dataSources.push(r.get(l)),a.data.push(o.get(l))},V=(0,r.iH)(null),C=()=>{F.value={lazy:!0,lazyLoad(a,e){const{level:o}=a;setTimeout((()=>{let r=null;if(1==o){const t=a.value.split(";");r=D(t[1],t[0]),r.then((a=>{null==a&&e([]);const t=a.map((a=>({value:a,label:a,leaf:o>=1})));e(t)}))}else{r=t.migrationsForm.migrationDataSources,null==r&&e([]),r=r.filter((a=>"{}"!=JSON.stringify(a))),null==r&&e([]);const a=r.map(((a,e)=>({value:a.databaseName+";"+a.sourceId+";"+a.uniqueName+";"+a.type+";"+e,label:a.databaseName,leaf:o>=1})));0==a.length&&e([]),e(a)}}),10)}}};return e({tableformRef:V,tableInit:k}),(0,o.YP)(b,((a,e)=>{const o=JSON.parse(a);JSON.parse(e);o.forEach(((a,e)=>{const o=f.value[e];t.migrationsForm.migrationDataSources.forEach((e=>{null!=e.migrationTables&&e.migrationTables.forEach((e=>{e.random==o&&(e.position=a)}))}))}))})),(e,t)=>{const i=(0,o.up)("el-cascader"),l=(0,o.up)("el-col"),b=(0,o.up)("el-input"),w=(0,o.up)("el-button"),_=(0,o.up)("el-form-item"),D=(0,o.up)("el-input-number"),k=(0,o.up)("el-form");return(0,o.wg)(),(0,o.j4)(k,{model:a.migrationsForm,"label-width":"150px"},{default:(0,o.w5)((()=>[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(d.value,((e,t)=>((0,o.wg)(),(0,o.j4)(_,{label:"添加数据库",prop:"migrationDataSources",key:t},{default:(0,o.w5)((()=>[(0,o.Wm)(l,{span:8},{default:(0,o.w5)((()=>[(0,o.Wm)(i,{ref_for:!0,ref_key:"databaseRef",ref:n,modelValue:a.migrationsForm.databaseName[t],"onUpdate:modelValue":e=>a.migrationsForm.databaseName[t]=e,props:S.value,"show-all-levels":!1,onChange:a=>h(a,t),clearable:""},null,8,["modelValue","onUpdate:modelValue","props","onChange"])])),_:2},1024),(0,o.Wm)(l,{span:2},{default:(0,o.w5)((()=>[m])),_:1}),(0,o.Wm)(l,{span:10},{default:(0,o.w5)((()=>[(0,o.Wm)(b,{style:{height:"35px",width:"300px"},modelValue:a.migrationsForm.migrationDataSources[t].uniqueName,"onUpdate:modelValue":e=>a.migrationsForm.migrationDataSources[t].uniqueName=e},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),(0,o.Wm)(l,{span:3},{default:(0,o.w5)((()=>[0==t?((0,o.wg)(),(0,o.j4)(w,{key:0,type:"primary",onClick:v,plain:""},{default:(0,o.w5)((()=>[(0,o.Uk)("+新增数据库")])),_:1})):(0,o.kq)("",!0)])),_:2},1024)])),_:2},1024)))),128)),((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(f.value,((e,t)=>((0,o.wg)(),(0,o.j4)(_,{label:"选择迁移表",key:t},{default:(0,o.w5)((()=>[(0,o.Wm)(l,{span:8},{default:(0,o.w5)((()=>[(0,o.Wm)(i,{ref_for:!0,ref_key:"tableRef",ref:g,modelValue:a.migrationsForm.data[t],"onUpdate:modelValue":e=>a.migrationsForm.data[t]=e,props:(0,r.SU)(F),"show-all-levels":!1,onChange:a=>N(a,t,1)},null,8,["modelValue","onUpdate:modelValue","props","onChange"])])),_:2},1024),(0,o.Wm)(l,{span:2},{default:(0,o.w5)((()=>[s])),_:1}),(0,o.Wm)(l,{span:6},{default:(0,o.w5)((()=>[(0,o.Uk)("       "),(0,o.Wm)(i,{ref_for:!0,ref_key:"tableRefSources",ref:c,modelValue:a.migrationsForm.dataSources[t],"onUpdate:modelValue":e=>a.migrationsForm.dataSources[t]=e,props:(0,r.SU)(F),"show-all-levels":!1,onChange:a=>N(a,t,2)},null,8,["modelValue","onUpdate:modelValue","props","onChange"])])),_:2},1024),(0,o.Wm)(l,{span:1},{default:(0,o.w5)((()=>[u])),_:1}),(0,o.Wm)(l,{span:4},{default:(0,o.w5)((()=>[(0,o.Wm)(D,{modelValue:p[t],"onUpdate:modelValue":a=>p[t]=a},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),(0,o.Wm)(l,{span:3},{default:(0,o.w5)((()=>[0==t?((0,o.wg)(),(0,o.j4)(w,{key:0,type:"primary",onClick:y,plain:""},{default:(0,o.w5)((()=>[(0,o.Uk)("+新增表")])),_:1})):(0,o.kq)("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},8,["model"])}}},g=t(89);const p=(0,g.Z)(d,[["__scopeId","data-v-1028fd36"]]);var c=p}}]);
//# sourceMappingURL=226.ae8c4a67.js.map